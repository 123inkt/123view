{%- set prev_line_visible = null -%}

<div class="diff-file__diff-block">
    {%- set line_number          = 1 -%}
    {%- set line_offset          = 0 -%}
    {%- set invisible_lines      = 0 -%}
    {%- set show_invisible_lines = file.totalNrOfLines < 5000 %}

    {%- for line_index, line in block.lines -%}
        {#- determine line_number and line_number offset -#}
        {%- if line.lineNumberBefore == null -%}
            {%- set line_offset = line_offset + 1 -%}
        {%- else -%}
            {%- set line_number = line.lineNumberBefore %}
            {%- set line_offset = 0 -%}
        {%- endif -%}

        {%- set line_visible = block.isLineVisible(line_index, 8) -%}

        {%- if prev_line_visible is same as (false) and line_visible is same as (true) -%}
            {% if show_invisible_lines %}
                {%- include 'app/review/commit/commit.block.spacer.html.twig' with {invisible_lines} -%}
            {% else %}
                {%- include 'app/review/commit/commit.block.spacer.blocked.html.twig' with {invisible_lines} -%}
            {% endif %}
        {%- endif -%}

        {#- keep track of the amount of invisible lines -#}
        {%- set invisible_lines   = line_visible is same as (false) ? invisible_lines + 1 : 0 -%}
        {%- set prev_line_visible = line_visible -%}

        {#- line of code -#}
        {% if line_visible or show_invisible_lines %}
            {%- include 'app/review/commit/commit.line.html.twig' -%}
        {% endif %}

        {#- comments -#}
        {%- for comment in commentsViewModel.getComments(line) -%}
            {%- include 'app/review/comment/comment.html.twig' -%}
        {%- endfor -%}

        <div data-role="add-comment-inserter"></div>

        {#- last line, and not eof -#}
        {%- if loop.last and line_visible is same as (false) -%}
            {% if show_invisible_lines %}
                {%- include 'app/review/commit/commit.block.spacer.html.twig' with {invisible_lines} -%}
            {% else %}
                {%- include 'app/review/commit/commit.block.spacer.blocked.html.twig' with {invisible_lines} -%}
            {% endif %}
        {%- endif -%}

    {%- endfor -%}
</div>
