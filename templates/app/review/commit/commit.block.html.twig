<div class="diff-file__diff-block">
    {%- set line_number = 1 %}
    {%- set line_offset = 0 -%}

    {%- for line in block.lines -%}
        {#- determine line_number and line_number offset -#}
        {%- if line.lineNumberBefore == null -%}
            {%- set line_offset = line_offset + 1 -%}
        {%- else -%}
            {%- set line_number = line.lineNumberBefore %}
            {%- set line_offset = 0 -%}
        {%- endif -%}

        {%- set line_modifier = '&nbsp;' -%}
        {%- set line_style = '' -%}

        {%- if line.state == 1 -%}
            {%- set line_modifier = '+' %}
            {%- set line_style = 'diff-file__line-change-added' -%}
        {%- elseif line.state == 2 -%}
            {%- set line_modifier = '-' %}
            {%- set line_style = 'diff-file__line-change-removed' %}
        {%- elseif line.state == 3 -%}
            {%- set line_modifier = '*' %}
            {%- set line_style = 'diff-file__line-change-changed' -%}
        {%- endif -%}

        <div class="diff-file__diff-line {{ line_style }}">
            {#- gutter -#}
            <span class="diff-file__line-gutter"
                  data-role="line-add-comment"
                  data-line="{{ line_number }}"
                  data-line-offset="{{ line_offset }}"
                  data-line-after="{{ line.lineNumberAfter|default('0') }}"
            >
                {#- add comments -#}
                <span class="diff-file__add-comment"><i class="bi bi-pencil-fill"></i></span>

                {#- line number -#}
                <span class="diff-file__line-numbers">
                    {{- line.lineNumberBefore|strpad(line_nr_length_before) -}}
                    &nbsp;
                    {{- line.lineNumberAfter|strpad(line_nr_length_after) -}}
                </span></span>
            {#- line state -#}
            <span class="diff-file__diff-change-state">{{ line_modifier|raw }}</span>

            {#- code changes -#}
            {%- for change in line.changes -%}
                {%- set code = change.code|highlight(file.extension, 'diff-file__code-keyword') -%}

                {%- if change.type == 1 and (line.state != 1 or line.changes|length > 1) -%}
                    <span class="diff-file__change-added">{{ code|raw }}</span>
                {%- elseif change.type == 2 and (line.state != 2 or line.changes|length > 1) -%}
                    <span class="diff-file__change-removed">{{ code|raw }}</span>
                {%- else %}{{ code|raw }}{% endif -%}
            {%- endfor -%}
        </div>

        {#- add comment form -#}
        {%- if addCommentForm is not null and addCommentForm.diffLine is same as line -%}
            <div class="diff-file__add-comment_form" data-controller="AddComment">
                {{- form_start(addCommentForm.form) -}}
                {{- form_widget(addCommentForm.form.message, {attr: {class: 'diff-file__add-comment_textarea', 'data-role': 'add-comment-textarea'}}) -}}
                {{- form_widget(addCommentForm.form.save) -}}
                <button type="button" class="ms-2 btn btn-outline-secondary" data-role="cancel-comment">{{ 'Cancel'|trans }}</button>

                {{- form_end(addCommentForm.form) -}}
            </div>
        {%- endif -%}

    {%- endfor -%}
</div>
