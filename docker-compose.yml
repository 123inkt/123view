version: '3'

services:
    nginx:
        build:
            args:
                VERSION: $NGINX_VERSION
            context: .
            dockerfile: ./docker/nginx/Dockerfile
        volumes:
            - ./public:/app/public
        depends_on:
            - php-fpm
        ports:
            - ${NGINX_PORT:-8080}:80

    php-fpm:
        build:
            args:
                VERSION: $PHP_VERSION
                COMPOSER_VERSION: $COMPOSER_VERSION
            context: .
            dockerfile: ./docker/php-fpm/Dockerfile
            target: dev
        environment:
            XDEBUG_MODE: debug
            XDEBUG_CONFIG: client_host=host.docker.internal discover_client_host=true start_with_request=trigger
            PHP_IDE_CONFIG: serverName=localhost
            DATABASE_URL: mysql://${DB_USER:-dev}:${DB_PASS:-123inkt}@mysql:3306/${DB_NAME:-commit-notification}?serverVersion=8.0&charset=utf8mb4
            APP_ENV: dev
        depends_on:
            - mysql
        volumes:
            - .:/app:rw

    mysql:
        build:
            args:
                VERSION: $MYSQL_VERSION
            context: ./docker/mysql
        environment:
            MYSQL_USER: ${DB_USER:-dev}
            MYSQL_PASSWORD: ${DB_PASS:-123inkt}
            MYSQL_DATABASE: ${DB_NAME:-commit-notification}
            MYSQL_ROOT_PASSWORD: ${DB_PASS:-123inkt}
        volumes:
            - ./docker/db/data:/var/lib/mysql
        ports:
            - ${MYSQL_PORT:-3306}:3306

networks:
    default:
        name: commit-notification-network
