version: '3'

services:
    nginx:
        build:
            args:
                VERSION: $NGINX_VERSION
                PIPELINE_NUMBER: dev
                APPLICATION_IMAGE: 'dev' # dev placeholder for application image as it's only used in pipelines
            context: .
            dockerfile: ./docker/nginx/Dockerfile
            target: dev
        volumes:
            - ./public:/app/public
        depends_on:
            - php-fpm
        ports:
            - 8000:80

    php-fpm:
        build:
            args:
                VERSION: $PHP_VERSION
                COMPOSER_VERSION: $COMPOSER_VERSION
                PIPELINE_NUMBER: dev
            context: .
            dockerfile: ./docker/php-fpm/Dockerfile
            target: dev
        environment:
            XDEBUG_MODE: debug
            XDEBUG_CONFIG: client_host=host.docker.internal discover_client_host=true start_with_request=trigger
            PHP_IDE_CONFIG: serverName=localhost
            BUILDNUMBER: dev
            APP_ENV: dev
        volumes:
            - .:/app:rw
        depends_on:
            - mysql

    mysql:
        build:
            args:
                VERSION: $MYSQL_VERSION
                PIPELINE_NUMBER: dev
            context: ./docker/mysql
            target: dev
        environment:
            MYSQL_USER: ${DB_USER:-dev}
            MYSQL_PASSWORD: ${DB_PASS:-123inkt}
            MYSQL_DATABASE: ${DB_NAME:-commit-notification}
            MYSQL_ROOT_PASSWORD: ${DB_PASS:-123inkt}
        volumes:
            - ./docker/db/data:/var/lib/mysql
        ports:
            - 3306:3306
